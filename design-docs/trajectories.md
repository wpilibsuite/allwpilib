# Trajectories 2: Better Edition

## Problem 

WPILib currently has a very limited trajectory API;
it only allows for cubic or quintic splines,
and only for tangential heading interpolation.
This works for differential drive robots,
but holonomic robots are able to follow more complex trajectories.

This document describes a new trajectory API that can be used
by both differential drive and holonomic robots,
and a builder-style trajectory generator that can generate trajectories
for both types of robot.

## Goals 

1. Define a trajectory API that can represent a wide variety of trajectories,
   including those generated by Choreo and PathPlanner.
2. Create a trajectory generator that can generate trajectories
   for both differential drive and holonomic robots.
3. Allow future trajectory generation algorithms to be added
   without changing the API.

## Non-Goals

1. Replace tools like Choreo and PathPlanner. 
   This API is intended to be used by those tools,
   not to replace them.

## Design

There are a few new classes that this API will use:

### ChassisAcceleration 

The `ChassisAcceleration` class represents the acceleration of a chassis.
It is basically just ChassisSpeeds except it is for accelerations instead of velocities:

```java
public class ChassisAccelerations {
    public final double ax;
    public final double ay;
    public final double alpha;
    
    /* constructors and stuff */
}
```

### Sample 

The `Sample` class represents a single point on a trajectory.
It contains the position, velocity, and acceleration of the chassis
at that point, as well as the time at which the point occurs.

It is implemented as a static inner class of `Trajectory`.

```java
public static class Sample {
    public final double time;
    public final Pose2d pose;
    public final ChassisSpeeds chassisSpeeds;
    public final ChassisAccelerations chassisAccelerations;
    
    /* constructors and stuff */
}
```

A `DifferentialSample` class will be used to represent a sample
for a differential drive robot, 
which extends `Sample` and calculates the left and right wheel speeds
given the chassis speeds and the drivetrain kinematics.

### Trajectory

The `Trajectory` class represents a trajectory,
which will be implemented as a list of `Sample`s
that are linearly interpolated between.

The following methods will be implemented as 
part of the public API of the `Trajectory` class:

```java
public class Trajectory {
    public Time duration();
    public Distance length();
    
    public Sample sampleAt(double time);
    public Pose2d poseAt(double time);
}
```

### Builders

The `TrajectoryBuilder` class is used to generate trajectories.
It will be implemented as a builder pattern,
with a fluent interface.

```java
Trajectory trajectory = TrajectoryBuilder.createWithConstraints(
    startPose,
    velConstraint, 
    accelConstraint
)
.forward(distance)
.turnBy(angle)
.splineTo(waypoint1, tangent1)
.build();
```

By default, the trajectory will use tangential heading interpolation.

Other heading interpolation styles can be used instead
on `lineTo` and `splineTo` methods:`
- `linearHeading` linearly interpolates the heading
- `splineHeading` interpolates the heading using a 1d spline
- `constantHeading` uses the heading of the previous point

```java
Trajectory trajectory = TrajectoryBuilder.createWithConstraints(
    startPose,
    velConstraint, 
    accelConstraint
)
.forward(distance)
.turnBy(angle)
.splineTo(waypoint1, tangent1)
.splineToLinearHeading(waypoint2, heading1, tangent2)
.lineToConstantHeading(waypoint3)
.splineToSplineHeading(waypoint4, heading2, tangent3)
.build();
```

The following paths will be supported:
- `forward(Distance)` straight line in current direction
- `turnBy(Angle)` turns desired angle
- `turnTo(Rotation2d)`turns to reach desired heading
- `splineTo(Translation2d, Rotation2d)` spline path to the waypoint with the given tangent
- `lineTo(Translation2d)` straight line to given waypoint
- `curveTo(Translation2d...)` Bézier curve path to the given waypoints

### Constraints

The `VelocityConstraint` and `AccelerationConstraint` classes
will be used to define the constraints of the trajectory.

## Implementation

### Paths 

The `PositionPath` interface will be used to represent 2D
paths (using `Translation2d`s).
Lines, splines, and Bézier curve paths will be supported.

The `HeadingPath` interface will be used to represent 2D
paths (using `Rotation2d`s), 
which lets us decouple the position and heading of the robot.
Tangential, linear, and spline interpolation will be supported.

The `Path` class simply composes a `PositionPath` and a `HeadingPath`.

### Profiles

The `Profile` class will profile a `Path`
given a `TrajectoryConstraints` object 
and provide the samples that make up the trajectory.