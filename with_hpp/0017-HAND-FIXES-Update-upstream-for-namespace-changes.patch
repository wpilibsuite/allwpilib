From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: PJ Reiniger <pj.reiniger@gmail.com>
Date: Wed, 8 Oct 2025 03:30:37 -0400
Subject: [PATCH 17/26] HAND FIXES: Update upstream for namespace changes

---
 upstream_utils/argparse_lib.py                     |  4 ++--
 upstream_utils/debugging.py                        |  2 +-
 .../0005-Add-emscripten-shim.patch                 |  4 ++--
 upstream_utils/expected.py                         |  4 ++--
 upstream_utils/json.py                             |  4 ++--
 upstream_utils/llvm.py                             | 12 ++++++------
 .../llvm_patches/0017-Windows-support.patch        | 14 +++++++-------
 .../llvm_patches/0019-Prefer-fmtlib.patch          | 10 +++++-----
 .../0021-Remove-unused-functions.patch             |  2 +-
 .../llvm_patches/0022-OS-specific-changes.patch    |  4 ++--
 upstream_utils/sleipnir.py                         |  2 +-
 .../sleipnir_patches/0003-Use-wpi-byteswap.patch   |  4 ++--
 12 files changed, 33 insertions(+), 33 deletions(-)

diff --git a/upstream_utils/argparse_lib.py b/upstream_utils/argparse_lib.py
index 03982fe02b5fe4a7aa1db0e4425076a5475a7130..b6113c0c546e241fd11a2b613dc3451235019c5d 100755
--- a/upstream_utils/argparse_lib.py
+++ b/upstream_utils/argparse_lib.py
@@ -17,8 +17,8 @@ def copy_upstream_src(wpilib_root: Path):
     # Rename namespace from argparse to wpi
     with open(dest_filename) as f:
         content = f.read()
-    content = content.replace("namespace argparse", "namespace wpi")
-    content = content.replace("argparse::", "wpi::")
+    content = content.replace("namespace argparse", "namespace wpi::util")
+    content = content.replace("argparse::", "wpi::util::")
     content = content.replace("ARGPARSE_", "WPI_")
     with open(dest_filename, "w") as f:
         f.write(content)
diff --git a/upstream_utils/debugging.py b/upstream_utils/debugging.py
index a56348682c14468afab156def43a657bd1ef74f0..12814834ade9545deb42daf28499d6fda4fc4f56 100755
--- a/upstream_utils/debugging.py
+++ b/upstream_utils/debugging.py
@@ -27,7 +27,7 @@ def copy_upstream_src(wpilib_root: Path):
             content = f.read()
 
         # Rename namespace from stdx to wpi
-        content = content.replace("namespace stdx", "namespace wpi")
+        content = content.replace("namespace stdx", "namespace wpi::util")
 
         with open(filename, "w") as f:
             f.write(content)
diff --git a/upstream_utils/debugging_patches/0005-Add-emscripten-shim.patch b/upstream_utils/debugging_patches/0005-Add-emscripten-shim.patch
index eef5288a630b211b2963b2602e2636ee66de6254..bb354aacd06db8b9c23aa3ca3cdbde533d4f751c 100644
--- a/upstream_utils/debugging_patches/0005-Add-emscripten-shim.patch
+++ b/upstream_utils/debugging_patches/0005-Add-emscripten-shim.patch
@@ -22,13 +22,13 @@ index 0000000000000000000000000000000000000000..16924894cc0c6085b27b33e6b9f2a6e6
 +#	include <fstream>
 +#	include <string>
 +
-+namespace wpi {
++namespace wpi::util {
 +
 +bool is_debugger_present() noexcept
 +{
 +  return false;
 +}
 +
-+} // namespace wpi
++} // namespace wpi::util
 +
 +#endif
diff --git a/upstream_utils/expected.py b/upstream_utils/expected.py
index 4b1bfcfcb193e19b202724718d7388846e24417f..9c990cd9b299fed680ad5151ff599394d035bc72 100755
--- a/upstream_utils/expected.py
+++ b/upstream_utils/expected.py
@@ -18,8 +18,8 @@ def copy_upstream_src(wpilib_root: Path):
     # Rename namespace from tl to wpi, and detail to detail_expected
     with open(dest_filename) as f:
         content = f.read()
-    content = content.replace("namespace tl", "namespace wpi")
-    content = content.replace("tl::", "wpi::")
+    content = content.replace("namespace tl", "namespace wpi::util")
+    content = content.replace("tl::", "wpi::util::")
     content = content.replace("TL_", "WPI_")
     content = content.replace("namespace detail", "namespace detail_expected")
     content = content.replace("detail::", "detail_expected::")
diff --git a/upstream_utils/json.py b/upstream_utils/json.py
index 90f0491f83b9ee74b12e72522f857af39fb3d036..3927b17c407286cd1aaf65f8960aaeb8f2854520 100755
--- a/upstream_utils/json.py
+++ b/upstream_utils/json.py
@@ -35,8 +35,8 @@ def copy_upstream_src(wpilib_root: Path):
             content = f.read()
 
         # Rename namespace from nlohmann to wpi
-        content = content.replace("namespace nlohmann", "namespace wpi")
-        content = content.replace("nlohmann::", "wpi::")
+        content = content.replace("namespace nlohmann", "namespace wpi::util")
+        content = content.replace("nlohmann::", "wpi::util::")
 
         # Fix internal includes
         content = content.replace(".hpp>", ".h>")
diff --git a/upstream_utils/llvm.py b/upstream_utils/llvm.py
index 63b68a80141598e419590863ff9a126db49b53bc..1368c287a602912c887c9f96d1886b0fbd1a90d8 100755
--- a/upstream_utils/llvm.py
+++ b/upstream_utils/llvm.py
@@ -12,8 +12,8 @@ def run_global_replacements(wpiutil_llvm_files: list[Path]):
             content = f.read()
 
         # Rename namespace from llvm to wpi
-        content = content.replace("namespace llvm", "namespace wpi")
-        content = content.replace("llvm:", "wpi:")
+        content = content.replace("namespace llvm", "namespace wpi::util")
+        content = content.replace("llvm:", "wpi::util:")
 
         # Fix #includes
         content = content.replace('include "llvm/ADT', 'include "wpi/util')
@@ -80,10 +80,10 @@ def run_global_replacements(wpiutil_llvm_files: list[Path]):
         content = content.replace("llvm_is_multithreaded()", "1")
 
         # Revert message in copyright header
-        content = content.replace("/// Defines the wpi::", "/// Defines the llvm::")
-        content = content.replace("// end llvm namespace", "// end wpi namespace")
-        content = content.replace("// end namespace llvm", "// end namespace wpi")
-        content = content.replace("// End llvm namespace", "// End wpi namespace")
+        content = content.replace("/// Defines the wpi::util::", "/// Defines the llvm::")
+        content = content.replace("// end llvm namespace", "// end wpi::util namespace")
+        content = content.replace("// end namespace llvm", "// end namespace wpi::util")
+        content = content.replace("// End llvm namespace", "// End wpi::util namespace")
 
         content = content.replace("fs::openFileForRead", "fs::OpenFileForRead")
 
diff --git a/upstream_utils/llvm_patches/0017-Windows-support.patch b/upstream_utils/llvm_patches/0017-Windows-support.patch
index 44e0795a5fbdc3ecfc4e91f99f98f07bd0db05c7..25f8cd4604ff13bb7a2c527e7d917d5da32234a6 100644
--- a/upstream_utils/llvm_patches/0017-Windows-support.patch
+++ b/upstream_utils/llvm_patches/0017-Windows-support.patch
@@ -91,7 +91,7 @@ index 83d5586ae8a77ec585e7e59df3075ca59cfb9d0c..395965bc6fc969ed9a2d92743a0010dd
  } // end namespace llvm.
  
 diff --git a/llvm/lib/Support/ConvertUTF.cpp b/llvm/lib/Support/ConvertUTF.cpp
-index bc04c5ab5113563fb82d7b3b168985369b611f4b..14fb61ff3465f08a931981f560ea5b176ca888b8 100644
+index bc04c5ab5113563fb82d7b3b168985369b611f4b..b1012d896bd8ba9e07221f87a358b90fe203b172 100644
 --- a/llvm/lib/Support/ConvertUTF.cpp
 +++ b/llvm/lib/Support/ConvertUTF.cpp
 @@ -67,6 +67,11 @@
@@ -116,7 +116,7 @@ index bc04c5ab5113563fb82d7b3b168985369b611f4b..14fb61ff3465f08a931981f560ea5b17
 +namespace windows {
 +std::error_code CodePageToUTF16(unsigned codepage,
 +                                std::string_view original,
-+                                wpi::SmallVectorImpl<wchar_t> &utf16) {
++                                wpi::util::SmallVectorImpl<wchar_t> &utf16) {
 +  if (!original.empty()) {
 +    int len = ::MultiByteToWideChar(codepage, MB_ERR_INVALID_CHARS, original.data(),
 +                                    original.size(), utf16.begin(), 0);
@@ -144,19 +144,19 @@ index bc04c5ab5113563fb82d7b3b168985369b611f4b..14fb61ff3465f08a931981f560ea5b17
 +}
 +
 +std::error_code UTF8ToUTF16(std::string_view utf8,
-+                            wpi::SmallVectorImpl<wchar_t> &utf16) {
++                            wpi::util::SmallVectorImpl<wchar_t> &utf16) {
 +  return CodePageToUTF16(CP_UTF8, utf8, utf16);
 +}
 +
 +std::error_code CurCPToUTF16(std::string_view curcp,
-+                            wpi::SmallVectorImpl<wchar_t> &utf16) {
++                            wpi::util::SmallVectorImpl<wchar_t> &utf16) {
 +  return CodePageToUTF16(CP_ACP, curcp, utf16);
 +}
 +
 +static
 +std::error_code UTF16ToCodePage(unsigned codepage, const wchar_t *utf16,
 +                                size_t utf16_len,
-+                                wpi::SmallVectorImpl<char> &converted) {
++                                wpi::util::SmallVectorImpl<char> &converted) {
 +  if (utf16_len) {
 +    // Get length.
 +    int len = ::WideCharToMultiByte(codepage, 0, utf16, utf16_len, converted.begin(),
@@ -186,12 +186,12 @@ index bc04c5ab5113563fb82d7b3b168985369b611f4b..14fb61ff3465f08a931981f560ea5b17
 +}
 +
 +std::error_code UTF16ToUTF8(const wchar_t *utf16, size_t utf16_len,
-+                            wpi::SmallVectorImpl<char> &utf8) {
++                            wpi::util::SmallVectorImpl<char> &utf8) {
 +  return UTF16ToCodePage(CP_UTF8, utf16, utf16_len, utf8);
 +}
 +
 +std::error_code UTF16ToCurCP(const wchar_t *utf16, size_t utf16_len,
-+                             wpi::SmallVectorImpl<char> &curcp) {
++                             wpi::util::SmallVectorImpl<char> &curcp) {
 +  return UTF16ToCodePage(CP_ACP, utf16, utf16_len, curcp);
 +}
 +
diff --git a/upstream_utils/llvm_patches/0019-Prefer-fmtlib.patch b/upstream_utils/llvm_patches/0019-Prefer-fmtlib.patch
index cd0fbacf424f9523ccbdd0c55bd70ce97b4a118a..6574605f037c3ab412acfd05e640ba684f3cb085 100644
--- a/upstream_utils/llvm_patches/0019-Prefer-fmtlib.patch
+++ b/upstream_utils/llvm_patches/0019-Prefer-fmtlib.patch
@@ -8,7 +8,7 @@ Subject: [PATCH 19/36] Prefer fmtlib
  1 file changed, 6 insertions(+), 14 deletions(-)
 
 diff --git a/llvm/lib/Support/ErrorHandling.cpp b/llvm/lib/Support/ErrorHandling.cpp
-index d0fd67bd3c0d4cf33922cdda042531424d277951..2f160c45b47cf57bb28f6393dd56cde06089639b 100644
+index d0fd67bd3c0d4cf33922cdda042531424d277951..c153b91391fe63e819e4907ac98d2ee26228107a 100644
 --- a/llvm/lib/Support/ErrorHandling.cpp
 +++ b/llvm/lib/Support/ErrorHandling.cpp
 @@ -22,7 +22,7 @@
@@ -33,7 +33,7 @@ index d0fd67bd3c0d4cf33922cdda042531424d277951..2f160c45b47cf57bb28f6393dd56cde0
 -    std::string_view MessageStr = OS.str();
 -    ssize_t written = ::write(2, MessageStr.data(), MessageStr.size());
 -    (void)written; // If something went wrong, we deliberately just give up.
-+    wpi::print(stderr, "LLVM ERROR: {}\n", Reason);
++    wpi::util::print(stderr, "LLVM ERROR: {}\n", Reason);
    }
  
    // If we reached here, we are failing ungracefully. Run the interrupt handlers
@@ -43,13 +43,13 @@ index d0fd67bd3c0d4cf33922cdda042531424d277951..2f160c45b47cf57bb28f6393dd56cde0
    if (msg)
 -    dbgs() << msg << "\n";
 -  dbgs() << "UNREACHABLE executed";
-+    wpi::print(stderr, "{}\n", msg);
++    wpi::util::print(stderr, "{}\n", msg);
 +  std::fputs("UNREACHABLE executed", stderr);
    if (file)
 -    dbgs() << " at " << file << ":" << line;
 -  dbgs() << "!\n";
-+    wpi::print(stderr, " at {}:{}", file, line);
-+  wpi::print(stderr, "!\n");
++    wpi::util::print(stderr, " at {}:{}", file, line);
++  wpi::util::print(stderr, "!\n");
    abort();
  #ifdef LLVM_BUILTIN_UNREACHABLE
    // Windows systems and possibly others don't declare abort() to be noreturn,
diff --git a/upstream_utils/llvm_patches/0021-Remove-unused-functions.patch b/upstream_utils/llvm_patches/0021-Remove-unused-functions.patch
index 099a7448c04645fd3f1a55782d67c687ff6bb913..04e8654d3a6b1225a22a3ef3ce361ee580edd0dd 100644
--- a/upstream_utils/llvm_patches/0021-Remove-unused-functions.patch
+++ b/upstream_utils/llvm_patches/0021-Remove-unused-functions.patch
@@ -48,7 +48,7 @@ index 990d3e4cfe53e025df6ce797f46f9de5af8ca6dc..264b8192a0473b94363765995517851c
    //===--------------------------------------------------------------------===//
    // Subclass Interface
 diff --git a/llvm/lib/Support/ErrorHandling.cpp b/llvm/lib/Support/ErrorHandling.cpp
-index 2f160c45b47cf57bb28f6393dd56cde06089639b..9ef6f7da66c66a35b1ce63e603e8590c214f9843 100644
+index c153b91391fe63e819e4907ac98d2ee26228107a..c9bb71be96f0ea3ad26c61cfa8ab35dfa6f60d02 100644
 --- a/llvm/lib/Support/ErrorHandling.cpp
 +++ b/llvm/lib/Support/ErrorHandling.cpp
 @@ -182,22 +182,6 @@ void llvm::llvm_unreachable_internal(const char *msg, const char *file,
diff --git a/upstream_utils/llvm_patches/0022-OS-specific-changes.patch b/upstream_utils/llvm_patches/0022-OS-specific-changes.patch
index 98407fe271dce77ef100df3a655bdcce85ce9c22..92def1c7c16905e40898a5cb7d4b25e1193df625 100644
--- a/upstream_utils/llvm_patches/0022-OS-specific-changes.patch
+++ b/upstream_utils/llvm_patches/0022-OS-specific-changes.patch
@@ -8,11 +8,11 @@ Subject: [PATCH 22/36] OS-specific changes
  1 file changed, 7 insertions(+), 9 deletions(-)
 
 diff --git a/llvm/lib/Support/ErrorHandling.cpp b/llvm/lib/Support/ErrorHandling.cpp
-index 9ef6f7da66c66a35b1ce63e603e8590c214f9843..4436b8e7f3a68ba85f184ee71014b9c1e0511d8a 100644
+index c9bb71be96f0ea3ad26c61cfa8ab35dfa6f60d02..01d46c847d274628fc2a8a39c44f0588b8c1bb06 100644
 --- a/llvm/lib/Support/ErrorHandling.cpp
 +++ b/llvm/lib/Support/ErrorHandling.cpp
 @@ -96,15 +96,7 @@ void llvm::report_fatal_error(std::string_view Reason, bool GenCrashDiag) {
-     wpi::print(stderr, "LLVM ERROR: {}\n", Reason);
+     wpi::util::print(stderr, "LLVM ERROR: {}\n", Reason);
    }
  
 -  // If we reached here, we are failing ungracefully. Run the interrupt handlers
diff --git a/upstream_utils/sleipnir.py b/upstream_utils/sleipnir.py
index 9d25f22e0194a271b4af98d3860a230c8aa2fa59..37ecee8b5cd238ae4115be1c47226ebbc59e4f07 100755
--- a/upstream_utils/sleipnir.py
+++ b/upstream_utils/sleipnir.py
@@ -42,7 +42,7 @@ def copy_upstream_src(wpilib_root: Path):
 namespace gch {
 
 template <typename T>
-using small_vector = wpi::SmallVector<T>;
+using small_vector = wpi::util::SmallVector<T>;
 
 }  // namespace gch
 """
diff --git a/upstream_utils/sleipnir_patches/0003-Use-wpi-byteswap.patch b/upstream_utils/sleipnir_patches/0003-Use-wpi-byteswap.patch
index 10e46e64adf8815f09418fb33064c5b96bd371ce..d662ca146d8898c58740f821e8cc76dac5711e40 100644
--- a/upstream_utils/sleipnir_patches/0003-Use-wpi-byteswap.patch
+++ b/upstream_utils/sleipnir_patches/0003-Use-wpi-byteswap.patch
@@ -19,7 +19,7 @@ index 4f4c76204071f90bf49eddb8c2aceb583b5e09ba..03938557c2600a7a1f72c6b93c935602
 +  ^wpi/
  }
 diff --git a/include/sleipnir/util/spy.hpp b/include/sleipnir/util/spy.hpp
-index a2f94803e3744cee771669210d1af883160e9896..3eaafb9748a9076eb9ede1d3979ec222c9a10e44 100644
+index a2f94803e3744cee771669210d1af883160e9896..40fafc563542e3ab405f5465c976cfbf0bcb9e08 100644
 --- a/include/sleipnir/util/spy.hpp
 +++ b/include/sleipnir/util/spy.hpp
 @@ -12,6 +12,7 @@
@@ -35,7 +35,7 @@ index a2f94803e3744cee771669210d1af883160e9896..3eaafb9748a9076eb9ede1d3979ec222
    void write32le(int32_t num) {
      if constexpr (std::endian::native != std::endian::little) {
 -      num = std::byteswap(num);
-+      num = wpi::byteswap(num);
++      num = wpi::util::byteswap(num);
      }
      m_file.write(reinterpret_cast<char*>(&num), sizeof(num));
    }
